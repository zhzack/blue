<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Home</title>
    <!-- plugins:css -->
    <link rel="stylesheet" th:href="@{/vendors/mdi/css/materialdesignicons.min.css}">
    <link rel="stylesheet" th:href="@{/vendors/base/vendor.bundle.base.css}">
    <!-- endinject -->
    <!-- plugin css for this page -->
    <link rel="stylesheet" th:href="@{/vendors/datatables.net-bs4/dataTables.bootstrap4.css}">
    <!-- End plugin css for this page -->
    <!-- inject:css -->
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <!-- endinject -->
    <link rel="shortcut icon" th:href="@{/images/favicon.png}"/>
    <link rel="stylesheet" th:href="@{../layui/css/layui.css}" media="all"/>
    <link rel="stylesheet" th:href="@{../layui/css/layui.mobile.css}" media="all"/>
    <script th:src="@{../jquery.min.js}"></script>
    <script th:src="@{../layui/layui.all.js}"></script>
    <script th:src="@{../layui/layui.js}"></script>
    <style>
        .threed {
            text-align: center;
            color: #eb7350;
            -webkit-text-stroke: 1px black;
            letter-spacing: 0.04em;
            background-color: white;
        }
    </style>
</head>

<body>
<div class="container-scroller">
    <!-- partial:partials/_navbar.html -->
    <div th:insert="~{/pages/commons/commons.html::navbar}"></div>
    <!-- partial -->
    <div class="container-fluid page-body-wrapper">
        <!-- partial:partials/_sidebar.html -->
        <div th:insert="~{/pages/commons/commons.html::siderbar}"></div>

        <!-- partial -->
        <div class="main-panel">
            <div class="content-wrapper" id="DevicesShow">
                <div class="row">
                    <div class="col-md-12 grid-margin">
                        <div class="d-flex justify-content-between flex-wrap">
                            <div class="d-flex align-items-end flex-wrap">
                                <div class="mr-md-3 mr-xl-5">
                                    <h2>Welcome back</h2>
                                </div>


                            </div>
                        </div>
                        <div class="col-2 float-right">
                            <button type="button" class="btn btn-secondary btn-rounded btn-fw"
                                    onclick="addDeviceBTN()">添加设备
                            </button>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12 grid-margin stretch-card" th:if="${deviceOnLines.size()}!=0">
                        <div class="card-header">
                            <div class="card-body dashboard-tabs p-0">
                                <ul class="nav nav-tabs px-4" role="tablist">
                                    <li class="nav-item" th:each="deviceOnLine: ${deviceOnLines}">
                                        <button type="button" class="btn btn-inverse-danger btn-fw btn-rounded"
                                                th:id="${deviceOnLine.getDevice_id()}+'-btn'"
                                                th:text="${deviceOnLine.getDevice_name()}"
                                                th:value="${deviceOnLine.getDevice_id()}"
                                                onclick="deviceShow(value)"
                                        >Device
                                        </button>
                                    </li>
                                </ul>
                            </div>
                        </div>

                    </div>
                    <div class="col-md-12 grid-margin stretch-card" id="deviceShow">
                        <div class="col-md-6 grid-margin stretch-card">
                            <div class="card">
                                <div class="card-body">
                                    <div class="chartjs-size-monitor"
                                         style="position: absolute; left: 0px; top: 0px; right: 0px; bottom: 0px; overflow: hidden; pointer-events: none; visibility: hidden; z-index: -1;">
                                        <div class="chartjs-size-monitor-expand"
                                             style="position:absolute;left:0;top:0;right:0;bottom:0;overflow:hidden;pointer-events:none;visibility:hidden;z-index:-1;">
                                            <div style="position:absolute;width:1000000px;height:1000000px;left:0;top:0"></div>
                                        </div>
                                        <div class="chartjs-size-monitor-shrink"
                                             style="position:absolute;left:0;top:0;right:0;bottom:0;overflow:hidden;pointer-events:none;visibility:hidden;z-index:-1;">
                                            <div style="position:absolute;width:200%;height:200%;left:0; top:0"></div>
                                        </div>
                                    </div>
                                    <!--                                    <p class="card-title">Cash deposits</p>-->
                                    <!--                                    <p class="mb-4">To start a blog, think of a topic about and first brainstorm party is ways to write-->
                                    <!--                                        details</p>-->
                                    <div id="cash-deposits-chart-legend" class="d-flex justify-content-center pt-3">
                                        <ul class="dashboard-chart-legend">
                                            <li><span style="background-color: #ff4747 "></span>Returns</li>
                                            <li><span style="background-color: #4d83ff "></span>Sales</li>
                                            <li><span style="background-color: #ffc100 "></span>Loss</li>
                                        </ul>
                                    </div>
                                    <canvas id="cash-deposits-chart" width="475" height="237"
                                            class="chartjs-render-monitor"
                                            style="display: block; width: 475px; height: 237px;"></canvas>
                                </div>

                            </div>
                        </div>
                        <div class="col-md-2 grid-margin stretch-card">
                            <div class="card">
                                <div class="card-body">
                                    <div class="card-title" id="noParameter_device">
                                        <div class="card-title grid-margin-xl-0">
                                            <button type="button" class="btn btn-block btn-dark">开关控制</button>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 grid-margin stretch-card">
                            <div class="card">
                                <div class="card-body">

                                    <div class="card-title">
                                        <div class="card-title">
                                            <button type="button" class="btn btn-block btn-dark">变量控制</button>
                                        </div>

                                        <div class="card-outline-primary" id="parameter_device">

                                        </div>


                                    </div>
                                    <div class="card-title">
                                        <div class="card-body" id="parameter_msg">

                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="card-header">
                        在线设备
                    </div>

                    <div class="col" id="OnLineDevices">

                    </div>
                </div>


                <div class="row">
                    <div class="card-header">
                        全部设备
                    </div>
                    <div class="card-body" id="AllDevices">
                    </div>
                </div>
            </div>


        </div>
        <div class="card-body">
        </div>
    </div>

</div>

</div>
<!-- content-wrapper ends -->

<!-- partial -->
</div>
<!-- main-panel ends -->
</div>
<!-- page-body-wrapper ends -->
</div>
<!-- container-scroller -->

<!-- plugins:js -->
<script th:src="@{vendors/base/vendor.bundle.base.js}"></script>
<!-- endinject -->
<!-- Plugin js for this page-->
<script th:src="@{vendors/chart.js/Chart.min.js}"></script>
<script th:src="@{vendors/datatables.net/jquery.dataTables.js}"></script>
<script th:src="@{vendors/datatables.net-bs4/dataTables.bootstrap4.js}"></script>
<!-- End plugin js for this page-->
<!-- inject:js -->
<script th:src="@{js/off-canvas.js}"></script>
<script th:src="@{js/hoverable-collapse.js}"></script>
<script th:src="@{js/template.js}"></script>
<!-- endinject -->
<!-- Custom js for this page-->
<script th:src="@{js/dashboard.js}"></script>
<script th:src="@{js/data-table.js}"></script>
<script th:src="@{js/jquery.dataTables.js}"></script>
<script th:src="@{js/dataTables.bootstrap4.js}"></script>
<!--<script th:src="@{../static/js/ws.js}"></script>-->
<!-- End custom js for this page-->
<script type="text/javascript">
    parameter_device()
    devices()
    connect()

    function sand_parameter_msg() {

    }

    function sand_no_parameter_msg(ss, dd) {

        asd = document.getElementById(ss + "_" + dd);
        // alert(ss+""+dd+"asd"+document.getElementById(ss+"_"+dd).getAttribute("child_device_name"));


        let device_id = asd.getAttribute("device_id");

        let child_device_id = asd.getAttribute("child_device_id");

        let child_device_name = asd.getAttribute("child_device_name");

        $.ajax({
                method: 'get',
                url: '/UserSandMsg',
                data: {
                    deviceId: device_id,
                    msg: child_device_name
                },
                success: function (to_user_id) {
                    let jsonMsg = JSON.stringify({
                        "msg": child_device_name,
                        "device_id": to_user_id,
                        "to_user_id": device_id
                    });

                    // ws.send(jsonMsg);

                    $.ajax({
                        method: 'get',
                        url: '/sendmsg',
                        data: {
                            "client_id": device_id,
                            "msg": child_device_name
                        },
                        success: function (data) {

                            console.log(data);
                        }
                    })
                    $("#content").html(content + '<div>\n' +
                        '                        <p><q style="color: coral">客户端:</q><span>' + writeMsg + '</span></p>\n' +
                        '                    </div>\n' +
                        '                    <br/>');
                }
                , error: function () {
                    alert("未绑定账户，请进入管理员页面添加");
                }
            }
        )


        // alert(child_device_name + "asd");
        // let jsonMsg = JSON.stringify({"msg": "卧室灯", "device_id": 101878, "to_user_id": 4});
        // ws.send(jsonMsg);

    }

    function noParameter_device(device_id) {
        let OnLineDevicesShow_ = document.getElementById("OnLineDevicesKeyShow_" + device_id);
        $.ajax({
            method: 'get',
            url: '/q_cd_byId',
            dataType: "json",
            data: {
                "device_id": device_id
            },
            success: function (data) {
                // OnLineDevicesShow_.innerHTML = "";
                data.forEach(function (child_device) {
                    OnLineDevicesShow_.innerHTML = OnLineDevicesShow_.innerHTML +
                        "<button class='btn btn-block btn-dark' " +
                        "device_id='" + child_device.device_id + "'" +
                        "child_device_id='" + child_device.child_device_id + "'" +
                        "child_device_name='" + child_device.child_device_name + "'" +
                        "onclick='sand_no_parameter_msg(" + child_device.device_id + "," + child_device.child_device_id + ")'" +
                        " id=" + child_device.device_id + "_" + child_device.child_device_id + " >"
                        + child_device.child_device_name + "</button>";
                })

                console.log(data);
            }
        })
        // noParameter_device.innerHTML = noParameter_device.innerHTML + "<div class=\"card-outline-primary\">\n" +
        //     "                                            <button type=\"button\" class=\"btn btn-inverse-success btn-block btn-fw\" " +
        //     "id='4' name='卧室灯' onclick='sand_no_parameter_msg(4,'卧室灯')' >卧室灯\n" +
        //     "                                            </button>\n" +
        //     "                                        </div>\n" +
        //     "                                        <div class=\"card-outline-primary border-left-0 grid-margin-xl-0\">\n" +
        //     "                                            <button type=\"button\" class=\"btn btn-inverse-primary btn-block btn-fw\">客厅灯\n" +
        //     "                                            </button>\n" +
        //     "                                        </div>";
    }

    function parameter_device() {
        let parameter_device = document.getElementById("parameter_device");
        parameter_device.innerHTML = "<button type=\"button\" class=\"btn btn-inverse-warning btn-block btn-fw\"\n" +
            "                                            onclick=\"parameter_msg()\">\n" +
            "                                                客厅空调\n" +
            "                                            </button>";

    }

    function parameter_msg() {
        let parameter_msg = document.getElementById("parameter_msg");
        parameter_msg.innerHTML = "<form class=\"forms-sample\">\n" +
            "                                                <div class=\"card-title\">\n" +
            "                                                <button type=\"button\" class=\"btn btn-block btn-light btn-large\">空调设置</button>\n" +
            "                                                </div>\n" +
            "                                                <div class=\"form-group row\">\n" +
            "                                                    <label for=\"exampleInputUsername2\"\n" +
            "                                                           class=\"col-sm-3 col-form-label\">温度</label>\n" +
            "                                                    <div class=\"col-sm-9\">\n" +
            "                                                        <input type=\"text\" class=\"form-control\"\n" +
            "                                                               id=\"exampleInputUsername2\" placeholder=\"温度（16-30）\">\n" +
            "                                                    </div>\n" +
            "                                                </div>\n" +
            "\n" +
            "                                                <div class=\"form-group row\" id=\"input_data\">\n" +
            "                                                    <label for=\"exampleFormControlSelect2\"\n" +
            "                                                           class=\"col-sm-3 col-form-label\">模式</label>\n" +
            "                                                    <div class=\"col-sm-9\">\n" +
            "                                                        <select class=\" form-control\"\n" +
            "                                                                id=\"exampleFormControlSelect2\">\n" +
            "                                                            <option>制冷</option>\n" +
            "                                                            <option>制暖</option>\n" +
            "                                                            <option>换气</option>\n" +
            "                                                        </select>\n" +
            "                                                    </div>\n" +
            "                                                </div>\n" +
            "                                                <button type=\"button\" class=\"btn btn-block btn-dark\">完成设置</button>\n" +
            "\n" +
            "                                            </form>"

    }

    function deviceShow(deviceId) {
        let deviceShow = document.getElementById("deviceShow");
        deviceShow.innerHTML = "<h1>123456</h1>";
    }

    function devices() {
        let onLineDevices = document.getElementById("device-online");
        let Devices = document.getElementById("device-all");
        let onLine_sum = document.getElementById("onLine_sum");
        let OnLineDevices = document.getElementById("OnLineDevices");
        let AllDevices = document.getElementById("AllDevices");
        $.ajax({
            method: 'get',
            url: '/getDevicesByUserId',
            dataType: "json",
            success: function (data) {
                Devices.innerHTML = "";
                onLineDevices.innerHTML = "";
                AllDevices.innerHTML = "";
                OnLineDevices.innerHTML = "";
                data.devices.forEach(function (item) {
                        Devices.innerHTML = Devices.innerHTML + "<ul class=\"nav flex-column sub-menu\" >\n" +
                            "                    <li class=\"nav-item\"><a class=\"nav-link\" href=\"#" + item.device_id + " \">" + item.device_name + "</a>\n" +
                            "                    </li>\n" +
                            "                </ul>";
                        AllDevices.innerHTML = AllDevices.innerHTML + "<div class=\"card-title\" id=\"AllDevicesShow_" + item.device_id + "\">" +
                            "<div class='card-header'>" + item.device_name + "</div></div>";
                    }
                )
                data.devicesOnLine.forEach(function (item) {
                    onLineDevices.innerHTML = onLineDevices.innerHTML + "<ul class=\"nav flex-column sub-menu\" >\n" +
                        "                    <li class=\"nav-item\"><a class=\"nav-link\" href=\"#" + item.device_id + " \">" + "<spam class=\"menu-title\">" + item.device_name + "</spam></a>\n" +
                        "                    </li>\n" +
                        "                </ul>";
                    OnLineDevices.innerHTML = OnLineDevices.innerHTML + "<div class=\"card \">\n" +
                        "                            <div class=\"card-header \">\n" +
                        "                                " + item.device_name + "\n" +
                        "                            </div>\n" +
                        "                            <div class=\"card-body\">\n" +
                        "                                <div class=\"col-md-12 grid-margin stretch-card\">\n" +
                        "                                    <div class=\"col-md-5  stretch-card\">\n" +
                        "                                        <div class=\"card\">\n" +
                        "                                            <div class=\"card-header\">接收收据</div>\n" +
                        "                                            <div class=\"card-body\" " +
                        "id='OnLineDevicesDataShow_" + item.device_id + "'></div>\n" +
                        "                                            <div class=\"card-footer\"></div>\n" +
                        "                                        </div>\n" +
                        "                                    </div>\n" +
                        "                                    <div class=\"col-md-3  stretch-card\">\n" +
                        "                                        <div class=\"card\">\n" +
                        "                                            <div class=\"card-header\">按键控制</div>\n" +
                        "                                            <div class=\"card-body\" " +
                        "id='OnLineDevicesKeyShow_" + item.device_id + "'></div>\n" +
                        "                                            <div class=\"card-footer\"></div>\n" +
                        "                                        </div>\n" +
                        "                                    </div>\n" +
                        "                                    <div class=\"col-md-4  stretch-card\">\n" +
                        "                                        <div class=\"card\">\n" +
                        "                                            <div class=\"card-header\">多参数控制</div>\n" +
                        "                                            <div class=\"card-body\"></div>\n" +
                        "                                            <div class=\"card-footer\"></div>\n" +
                        "                                        </div>\n" +
                        "                                    </div>\n" +

                        "                            </div>\n" +
                        "                        </div>";
                    // OnLineDevices.innerHTML = OnLineDevices.innerHTML + "<div class=\"card-title\" id=\"OnLineDevicesShow_" + item.device_id + "" +
                    //     "\"><div class='card-header'>" + item.device_name + "</div>" +
                    //     "<div class=\"col-md-3 grid-margin stretch-card\"><div" +
                    //     " class='card-title'>按键</div><div class='card-body' id=\"OnLineDevicesKeyShow_" + item.device_id + "" +
                    //     "\" </div></div>";
                })
                data.devicesOnLine.forEach(function (item) {
                        noParameter_device(item.device_id);
                    }
                )
                onLine_sum.innerHTML = data.devicesOnLine.length;
                //let deviceData=JSON.parse(data);
                // setTimeout(devices, 3000);
                // console.log(data.devices[0]);
                // console.log(data.devicesOnLine);
                // console.log(data);
            }
        })

    }

    function sendMsg() {
        let user = [];
        $("input[name='check']:checked").each(function (i) {//把所有被选中的复选框的值存入数组
            user = user + $(this).attr("title") + ","
        });
        console.log(user)

        if (user.length > 0) {
            user = user.substr(0, user.length - 1);
        } else {
            console.log("未选中发送人")
            var content = $("#content").html();
            $("#content").html(content + '<div style="margin-bottom: 8px">\n' +
                '                        <p><q style="color: red">' + '系统提示:请在多选框中选择要发送的用户' + '</span></p>\n' +
                '                    </div>\n' +
                '                    <br/>');
            return
        }

        var msg = $("#msg").val();
        if (msg != null) {
            $.ajax({
                method: 'get',
                url: '/sendmsg',
                data: {
                    "client_id": user,
                    "msg": msg
                },
                success: function (data) {
                    var content = $("#content").html();
                    $("#content").html(content + '<div style="margin-bottom: 8px">\n' +
                        '                        <p><q style="color: #eb7350">' + '服务器推送  ' + msg + ' -->' + user + '</span></p>\n' +
                        '                    </div>\n' +
                        '                    <br/>');
                    console.log(data);
                }
            })
        } else {
            alert("请填写要发送的用户昵称或者发送内容");
        }
    }

    function addDeviceBTN() {
        const divA = document.getElementById("page");
        divA.innerHTML = divA.innerHTML + '<div class="layui-form-item" id="addDevice">\n' +
            '                    <div class="layui-input-inline" style="width: 350px">\n' +
            '                        <input id="DeviceName" type="text" name="device" required lay-verify="required" placeholder="设备名称"\n' +
            '                               autocomplete="off" class="layui-input">\n' +
            '\n' +
            '                        <input id="DeviceId" type="text" name="device" required lay-verify="required" placeholder="设备id"\n' +
            '                               autocomplete="off" class="layui-input">' +
            '<button class="layui-btn" onclick="addDevice()">添加设备</button>\n' +
            '                    </div>\n' +
            '                </div>';

    }

    function addDevice() {

        let DeviceName = $("#DeviceName").val();
        let DeviceMac = $("#DeviceId").val();

        if (DeviceMac == null || DeviceName == null) {
            alert("您的输入有误，请检查后重新输入");
        } else {
            $.ajax({
                    method: 'get',
                    url: '/addDevice',
                    data: {
                        DeviceName: DeviceName,
                        DeviceMac: DeviceMac
                    },
                    success: function (data) {
                        if (data === "success") {
                            let obj = document.getElementById("addDevice");
                            obj.innerHTML = "";
                            alert("添加成功" + data);
                            location.reload();
                        } else {
                            alert("添加失败，请检查设备是否已经绑定" + data);
                        }
                    }
                    , error: function () {
                        alert("连接失败");
                    }
                }
            )
        }


    }

    function sendAll() {
        let msg = $("#msg").val();
        if (msg != null) {
            $.ajax({
                method: 'get',
                url: '/sendAll',
                data: {
                    msg: msg
                },
                success: function (data) {
                    var content = $("#content").html();
                    $("#content").html(content + '<div style="margin-bottom: 8px">\n' +
                        '                        <p><q style="color: #eb7350">' + '服务器推送  ' + msg + ' --> 所有用户' + '</span></p>\n' +
                        '                    </div>\n' +
                        '                    <br/>');
                    console.log(data);
                }
            })
        } else {
            alert("请填写要发送的内容");
        }
    }

    function connect() {
        const user_name = [[${session.loginUser.user_id}]];
        const Socket = "MozWebSocket" in window ? MozWebSocket : WebSocket;
        let ws = new Socket("ws://127.0.0.1/ws/" + user_name);

        ws.onmessage = function (evt) {
            var content = $("#content").html();
            $("#content").html(content + '<div style="text-align: right;margin-bottom: 8px">\n' +
                '                        <p><q style="color: mediumorchid;text-align: right">' + evt.data + '</span></p>\n' +
                '                    </div>\n' +
                '                    <br/>');
        };

        ws.onclose = function (evt) {
            console.log('连接关闭')
        };

        ws.onopen = function (evt) {
            var content = $("#content").html();
            $("#content").html(content + '<div style="margin-bottom: 8px">\n' +
                '                        <p><q style="color: #eb7350">' + '服务器初始化成功...' + '</span></p>\n' +
                '                    </div>\n' +
                '                    <br/>');
            console.log('连接成功')
        };
    }


</script>

</body>

</html>

